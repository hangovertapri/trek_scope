{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 23, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/src/middleware.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport type { NextMiddlewareResult } from 'next/dist/server/web/types';\r\n\r\n// Rate limiting store (in production, use Redis)\r\nconst rateLimitStore = new Map<string, { count: number; resetTime: number }>();\r\n\r\nconst RATE_LIMIT_WINDOW = 15 * 60 * 1000; // 15 minutes\r\nconst RATE_LIMIT_MAX_REQUESTS = 5; // Max 5 login attempts per IP\r\n\r\nfunction getRateLimitKey(ip: string, endpoint: string): string {\r\n  return `${ip}:${endpoint}`;\r\n}\r\n\r\nfunction getClientIp(request: NextRequest): string {\r\n  return (\r\n    request.headers.get('x-forwarded-for')?.split(',')[0] ||\r\n    request.headers.get('x-real-ip') ||\r\n    '127.0.0.1'\r\n  );\r\n}\r\n\r\nfunction checkRateLimit(key: string): boolean {\r\n  const now = Date.now();\r\n  const limit = rateLimitStore.get(key);\r\n\r\n  if (!limit || now > limit.resetTime) {\r\n    // Reset window\r\n    rateLimitStore.set(key, { count: 1, resetTime: now + RATE_LIMIT_WINDOW });\r\n    return true;\r\n  }\r\n\r\n  if (limit.count >= RATE_LIMIT_MAX_REQUESTS) {\r\n    return false;\r\n  }\r\n\r\n  limit.count++;\r\n  return true;\r\n}\r\n\r\n// CSRF token generation using Web Crypto API (Edge Runtime compatible)\r\nfunction generateCSRFToken(): string {\r\n  const array = new Uint8Array(32);\r\n  crypto.getRandomValues(array);\r\n  return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');\r\n}\r\n\r\nexport function middleware(request: NextRequest): NextMiddlewareResult {\r\n  const { pathname } = request.nextUrl;\r\n\r\n  // Apply rate limiting to auth endpoints\r\n  if (pathname === '/api/auth/callback/credentials' || pathname?.includes('/api/auth/signin')) {\r\n    const ip = getClientIp(request);\r\n    const key = getRateLimitKey(ip, 'auth');\r\n\r\n    if (!checkRateLimit(key)) {\r\n      return NextResponse.json(\r\n        { error: 'Too many login attempts. Please try again later.' },\r\n        { status: 429 }\r\n      );\r\n    }\r\n  }\r\n\r\n  // Add security headers\r\n  const response = NextResponse.next();\r\n\r\n  response.headers.set('X-Content-Type-Options', 'nosniff');\r\n  response.headers.set('X-Frame-Options', 'SAMEORIGIN');\r\n  response.headers.set('X-XSS-Protection', '1; mode=block');\r\n  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');\r\n  response.headers.set(\r\n    'Permissions-Policy',\r\n    'camera=(), microphone=(), geolocation=()'\r\n  );\r\n\r\n  // Add CSRF token to response headers (for client-side forms)\r\n  if (pathname?.includes('login')) {\r\n    response.headers.set('X-CSRF-Token', generateCSRFToken());\r\n  }\r\n\r\n  return response;\r\n}\r\n\r\nexport const config = {\r\n  matcher: [\r\n    '/api/auth/:path*',\r\n    '/admin/:path*',\r\n    '/agency/:path*',\r\n  ],\r\n};\r\n"],"names":[],"mappings":";;;;AAAA;AAAA;;AAGA,iDAAiD;AACjD,MAAM,iBAAiB,IAAI;AAE3B,MAAM,oBAAoB,KAAK,KAAK,MAAM,aAAa;AACvD,MAAM,0BAA0B,GAAG,8BAA8B;AAEjE,SAAS,gBAAgB,EAAU,EAAE,QAAgB;IACnD,OAAO,GAAG,GAAG,CAAC,EAAE,UAAU;AAC5B;AAEA,SAAS,YAAY,OAAoB;IACvC,OACE,QAAQ,OAAO,CAAC,GAAG,CAAC,oBAAoB,MAAM,IAAI,CAAC,EAAE,IACrD,QAAQ,OAAO,CAAC,GAAG,CAAC,gBACpB;AAEJ;AAEA,SAAS,eAAe,GAAW;IACjC,MAAM,MAAM,KAAK,GAAG;IACpB,MAAM,QAAQ,eAAe,GAAG,CAAC;IAEjC,IAAI,CAAC,SAAS,MAAM,MAAM,SAAS,EAAE;QACnC,eAAe;QACf,eAAe,GAAG,CAAC,KAAK;YAAE,OAAO;YAAG,WAAW,MAAM;QAAkB;QACvE,OAAO;IACT;IAEA,IAAI,MAAM,KAAK,IAAI,yBAAyB;QAC1C,OAAO;IACT;IAEA,MAAM,KAAK;IACX,OAAO;AACT;AAEA,uEAAuE;AACvE,SAAS;IACP,MAAM,QAAQ,IAAI,WAAW;IAC7B,OAAO,eAAe,CAAC;IACvB,OAAO,MAAM,IAAI,CAAC,OAAO,CAAA,OAAQ,KAAK,QAAQ,CAAC,IAAI,QAAQ,CAAC,GAAG,MAAM,IAAI,CAAC;AAC5E;AAEO,SAAS,WAAW,OAAoB;IAC7C,MAAM,EAAE,QAAQ,EAAE,GAAG,QAAQ,OAAO;IAEpC,wCAAwC;IACxC,IAAI,aAAa,oCAAoC,UAAU,SAAS,qBAAqB;QAC3F,MAAM,KAAK,YAAY;QACvB,MAAM,MAAM,gBAAgB,IAAI;QAEhC,IAAI,CAAC,eAAe,MAAM;YACxB,OAAO,6LAAA,CAAA,eAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAmD,GAC5D;gBAAE,QAAQ;YAAI;QAElB;IACF;IAEA,uBAAuB;IACvB,MAAM,WAAW,6LAAA,CAAA,eAAY,CAAC,IAAI;IAElC,SAAS,OAAO,CAAC,GAAG,CAAC,0BAA0B;IAC/C,SAAS,OAAO,CAAC,GAAG,CAAC,mBAAmB;IACxC,SAAS,OAAO,CAAC,GAAG,CAAC,oBAAoB;IACzC,SAAS,OAAO,CAAC,GAAG,CAAC,mBAAmB;IACxC,SAAS,OAAO,CAAC,GAAG,CAClB,sBACA;IAGF,6DAA6D;IAC7D,IAAI,UAAU,SAAS,UAAU;QAC/B,SAAS,OAAO,CAAC,GAAG,CAAC,gBAAgB;IACvC;IAEA,OAAO;AACT;AAEO,MAAM,SAAS;IACpB,SAAS;QACP;QACA;QACA;KACD;AACH"}}]
}